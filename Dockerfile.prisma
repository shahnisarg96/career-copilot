FROM node:22-alpine

WORKDIR /app
RUN apk add --no-cache libc6-compat postgresql-client

# Install workspace deps needed to run prisma-cli in the prisma-client package
COPY package*.json ./
COPY packages/common/package.json ./packages/common/
COPY packages/prisma-client/package.json ./packages/prisma-client/

RUN npm ci --workspace=packages/common --workspace=packages/prisma-client

# Copy the actual prisma schema
COPY packages/common ./packages/common
COPY packages/prisma-client ./packages/prisma-client

# Generate prisma client (doesn't require DB access)
RUN npm run prisma:generate

# Wait for Postgres then apply schema in a non-destructive way by default.
#
# Behavior can be controlled with env vars:
# - DB_SYNC_RESET=true: drops and recreates the schema via `prisma db push --force-reset` (destructive)
# - DB_SYNC_ACCEPT_DATA_LOSS=true: allows destructive schema changes during `prisma db push` (may drop columns)
# - DB_SYNC_SEED=true: runs the seed script
CMD sh -c "until pg_isready -h postgres -U ${POSTGRES_USER:-postgres}; do echo 'Waiting for postgres...'; sleep 2; done; cd packages/prisma-client; if [ -d prisma/migrations ] && [ \"$(ls -A prisma/migrations 2>/dev/null)\" ]; then npx prisma migrate deploy && echo 'Prisma migrate deploy complete.'; else if [ \"${DB_SYNC_RESET:-false}\" = 'true' ]; then npx prisma db push --force-reset --accept-data-loss && echo 'Prisma db push (force-reset) complete.'; elif [ \"${DB_SYNC_ACCEPT_DATA_LOSS:-false}\" = 'true' ]; then npx prisma db push --accept-data-loss && echo 'Prisma db push (accept-data-loss) complete.'; else npx prisma db push && echo 'Prisma db push complete.'; fi; fi; if [ \"${DB_SYNC_SEED:-true}\" = 'true' ]; then node prisma/seed.mjs && echo 'Seed complete.'; else echo 'Seed skipped (DB_SYNC_SEED=false).'; fi"
